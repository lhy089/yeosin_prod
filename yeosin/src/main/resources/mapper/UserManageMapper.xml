<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yeosin.admin.UserManageDao" >

	<!-- 회원 유저 조회 -->
	<select id="getUserInfo" parameterType="com.yeosin.user.UserDto" resultType="com.yeosin.user.UserDto">
		SELECT 	
			 	USERID
			,
			 	CASE 
      		   		WHEN USERSTATUS != 'D'	THEN '회원'
        		ELSE '탈퇴'
      		  	END AS USERSTATUS
			,	GRADE 
			,	USERNAME 
			,	GENDER 
			,	DATE_FORMAT(JOINDATE, '%Y-%m-%d') AS JOINDATE 
			,	DATE_FORMAT(LASTCONNECTDATE, '%Y-%m-%d') AS LASTCONNECTDATE 
			,	DATE_FORMAT(BIRTHDATE, '%Y-%m-%d') AS BIRTHDATE 
			,	CALLNUMBER
			,	PHONENUMBER
			,	EMAILADDRESS 
		FROM 	YS_USER U
		WHERE 	1 = 1
		<if test="searchWord != null and searchWord != ''">
				AND (USERNAME LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR},'%')
				OR USERID LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR},'%')
				OR PHONENUMBER LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR},'%')
				OR EMAILADDRESS LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR}, '%'))
		</if>
		<if test='searchEmailType=="Y"'>
			AND  ISRECEIVEEMAIL = 'Y'
		</if>
		<if test='searchEmailType=="N"'>
			AND	ISRECEIVEEMAIL = 'N'
		</if>
		<if test='searchSMSType=="Y"'>
			AND ISRECEIVESMS = 'Y'
		</if>
		<if test='searchSMSType=="N"'>
			AND ISRECEIVESMS = 'N'
		</if>
		LIMIT #{pageStart}, #{perPageNum};
   </select>
   
   <select id="countUserListTotal" parameterType="com.yeosin.user.UserDto" resultType="Integer">
		SELECT 	
			 count(*)
		FROM 	YS_USER U
		WHERE 	1 = 1
		<if test="searchWord != null and searchWord != ''">
				AND (USERNAME LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR},'%')
				OR USERID LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR},'%')
				OR PHONENUMBER LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR},'%')
				OR EMAILADDRESS LIKE CONCAT('%', #{searchWord, jdbcType=VARCHAR}, '%'))
		</if>
		<if test='searchEmailType=="Y"'>
			AND  ISRECEIVEEMAIL = 'Y'
		</if>
		<if test='searchEmailType=="N"'>
			AND	ISRECEIVEEMAIL = 'N'
		</if>
		<if test='searchSMSType=="Y"'>
			AND ISRECEIVESMS = 'Y'
		</if>
		<if test='searchSMSType=="N"'>
			AND ISRECEIVESMS = 'N'
		</if>
   </select>
   
   <insert id="insertEduCompletionHis" parameterType="com.yeosin.user.EduCompletionHisDto">
		INSERT INTO YS_EDUCOMPLETIONHIS
			(APISYNCID, APISYNCDATE, PASSSTARTDATE, PASSENDDATE, APISYNCTYPE)
		VALUES
			(#{apiSyncId}, now(), #{passStartDate}, #{passEndDate}, #{apiSyncType})
	</insert>
	
	<select id="getEduCompletionList" parameterType="com.yeosin.user.EduCompletionHisDto" resultType="com.yeosin.user.EduCompletionDto">
		SELECT 
				USERNAME
			,	BIRTHDATE
			,  	GENDER
			,	(SELECT SUBJECT.SUBJECTNAME FROM YS_SUBJECT SUBJECT WHERE SUBJECT.SUBJECTID = SUBJECT) 	AS SUBJECT
			,  	CERTID
			, 	APISYNCID
			, 	UPAPISYNCID
		FROM YS_EDUCOMPLETION
		WHERE 1 = 1
			<if test="apiSyncId !=null and apiSyncId != ''">
				AND (APISYNCID = #{apiSyncId} OR APISYNCID = #{apiSyncId})
			</if>
			<if test="searchWord !=null and searchWord != ''">
				AND (USERNAME LIKE CONCAT('%', #{searchWord},'%') OR CERTID LIKE CONCAT('%', #{searchWord},'%'))
			</if>
			<if test="gender !=null and gender != ''">
				AND GENDER = #{gender}
			</if>
			<if test="subject !=null and subject != ''">
				AND SUBJECT = #{subject}
			</if>
		ORDER BY USERNAME
	</select> 
	
	<select id="getEduCompletionHisList" resultType="com.yeosin.user.EduCompletionHisDto">
		SELECT
				APISYNCID
			,	APISYNCDATE
			,	PASSSTARTDATE
			,	PASSENDDATE 
			,	APISYNCTYPE 
		FROM YS_EDUCOMPLETIONHIS
		ORDER BY APISYNCDATE DESC
	</select> 
</mapper>