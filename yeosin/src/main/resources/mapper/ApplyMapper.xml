<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yeosin.apply.ApplyDao" >
   
	<!-- 로그인 유저의 원서접수 리스트 조회 -->
	<resultMap id="ApplyListResultMap" type="com.yeosin.apply.ApplyDto">
		<result column="RECEIPTID" property="receiptId" />
		<result column="USERID" property="userId" />
		<result column="EXAMID" property="examId" />
		<result column="ISCANCEL" property="isCancel"/>
 		<association property="examDto" javaType="com.yeosin.apply.ExamDto">
			<result column="EXAMNAME" property="examName" />
			<result column="EXAMDEGREE" property="examDegree"/>
			<result column="RECEIPTSTARTDATE" property="receiptStartDate" />
			<result column="RECEIPTENDDATE" property="receiptEndDate" />
			<result column="EXAMDATE" property="examDate" />
			<result column="EXAMLOCAL" property="examLocal" />
		</association>
		<association property="examZoneDto" javaType="com.yeosin.apply.ExamZoneDto">
			<result column="LOCALDETAIL" property="localDetail" />
		</association>
	</resultMap>
	<select id="getAcceptList" parameterType="com.yeosin.apply.ApplyDto" resultMap="ApplyListResultMap">
		SELECT 	
				R.RECEIPTID 				-- 접수 ID
			,	R.USERID 					-- 유저 ID
			,	R.EXAMID					-- 시험 ID
			,   R.ISCANCEL					-- 취소여부
			,	E.EXAMNAME 					-- 시험명
			,   DATE_FORMAT(E.RECEIPTSTARTDATE, '%Y-%m-%d')    	AS RECEIPTSTARTDATE 	-- 접수시작일
         	,   DATE_FORMAT(E.RECEIPTENDDATE, '%Y-%m-%d')       AS RECEIPTENDDATE    	-- 접수마감일
			,	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d')				AS EXAMDATE				-- 시험일
			,	EZ.LOCALDETAIL 				-- 시험지역
		FROM 	YS_RECEIPT					R 	
		INNER JOIN YS_EXAM 					E	ON 	E.EXAMID = R.EXAMID 	
		INNER JOIN YS_EXAMZONE				EZ 	ON 	EZ.EXAMZONEID = R.EXAMZONEID
		WHERE 	1 = 1
		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
		AND 	R.ISCANCEL = 'N'
		<![CDATA[
		AND 	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d')
		]]>
		ORDER BY E.EXAMDATE DESC
		LIMIT #{pageStart}, #{perPageNum};
   </select>
   
   <!-- 로그인 유저의 원서접수 총 갯수 조회 -->
   <select id="countAcceptListTotal"  parameterType="String" resultType="Integer">
   		SELECT 	count(*)
 		FROM   	YS_RECEIPT	R
 		INNER JOIN YS_EXAM	E	ON	E.EXAMID = R.EXAMID
 		INNER JOIN YS_EXAMZONE EZ ON EZ.EXAMZONEID = R.EXAMZONEID
 		WHERE	1 = 1
 		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
 		AND 	R.ISCANCEL = 'N'
		<![CDATA[
		AND 	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d');
		]]> 
	</select>
	
	<!-- 수험표 리스트 -->
	<select id="getTicketList" parameterType="com.yeosin.apply.ApplyDto" resultMap="ApplyListResultMap">
		SELECT 	
				R.RECEIPTID 				-- 접수 ID
			,	R.USERID 					-- 유저 ID
			,	R.EXAMID					-- 시험 ID
			,   R.ISCANCEL					-- 취소여부
			,	E.EXAMNAME 					-- 시험명
			,   DATE_FORMAT(E.RECEIPTSTARTDATE, '%Y-%m-%d')    	AS RECEIPTSTARTDATE 	-- 접수시작일
         	,   DATE_FORMAT(E.RECEIPTENDDATE, '%Y-%m-%d')       AS RECEIPTENDDATE    	-- 접수마감일
			,	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d')				AS EXAMDATE				-- 시험일
			,	EZ.LOCALDETAIL 				-- 시험지역
			,	CONCAT(CONVERT(DATE_FORMAT(E.EXAMDATE, '%Y'), CHAR), '년', ' ', CONVERT(E.EXAMDEGREE, CHAR), '회')	AS EXAMDEGREE	-- 시험회차
		FROM 	YS_RECEIPT					R 	
		INNER JOIN YS_EXAM 					E	ON 	E.EXAMID = R.EXAMID 	
		INNER JOIN YS_EXAMZONE				EZ 	ON 	EZ.EXAMZONEID = R.EXAMZONEID
		WHERE 	1 = 1
		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
		AND 	R.ISCANCEL = 'N'
		AND  	NOW() between E.CERTPRINTSTARTDATE AND E.CERTPRINTENDDATE
		ORDER BY E.EXAMDATE DESC
		LIMIT #{pageStart}, #{perPageNum};
   </select>
   
   <!-- 수험표 리스트 총 갯수 -->
   <select id="countTicketListTotal"  parameterType="String" resultType="Integer">
   		SELECT 	count(*)
 		FROM   	YS_RECEIPT	R
 		INNER JOIN YS_EXAM	E	ON	E.EXAMID = R.EXAMID
 		INNER JOIN YS_EXAMZONE EZ ON EZ.EXAMZONEID = R.EXAMZONEID
 		WHERE	1 = 1
 		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
 		AND 	R.ISCANCEL = 'N'
		AND  	NOW() between E.CERTPRINTSTARTDATE AND E.CERTPRINTENDDATE
	</select>
   
   	<!-- 로그인 유저의 접수별 상세현황 조회 -->
	<resultMap id="DetailApplyListResultMap" type="com.yeosin.apply.ApplyDto">
		<result column="RECEIPTDATE" property="receiptDate" />
		<result column="PAYMENTMETHOD" property="paymentMethod" />
		<result column="RECEIPTID" property="receiptId" />
		<result column="STUDENTCODE" property="studentCode" />
		<result column="EXAMFEE" property="examFee" />
		<result column="CERTID" property="certId" />
 		<association property="examDto" javaType="com.yeosin.apply.ExamDto">
			<result column="EXAMID" property="examId" />
			<result column="EXAMNAME" property="examName" />
			<result column="EXAMDEGREE" property="examDegree" />
			<result column="SUBJECTID" property="subjectId" />
			<result column="EXAMDATE" property="examDate" />
			<result column="GRADESTARTDATE" property="gradeStartDate" />
			<result column="GRADEENDDATE" property="gradeEndDate" />
			<result column="EXAMLOCAL" property="examLocal" />
		</association>
		<association property="userDto" javaType="com.yeosin.user.UserDto">
			<result column="USERID" property="userId" />
			<result column="USERNAME" property="userName" />
			<result column="PHONENUMBER" property="phoneNumber" />
			<result column="EMAILADDRESS" property="emailAddress" />
			<result column="BIRTHDATE" property="birthDate" />
		 </association>
		 <association property="subjectDto" javaType="com.yeosin.apply.SubjectDto">
			<result column="SUBJECTNAME" property="subjectName" />
		</association>
		<association property="gradeDto" javaType="com.yeosin.apply.GradeDto">
			<result column="ALLSCORE" property="allScore" />
			<result column="ISPASS" property="isPass" />
		</association>
		<association property="examZoneDto" javaType="com.yeosin.apply.ExamZoneDto">
			<result column="EXAMZONENAME" property="examZoneName" />
		</association>
	</resultMap>
	<select id="GetDetailApplyList" parameterType="map" resultMap="DetailApplyListResultMap">
		SELECT 	
				E.EXAMID 			-- 시험 ID 
			,	E.EXAMNAME 			-- 시험명
			,	E.EXAMDEGREE 		-- 시험차수
			,	U.USERID 			-- 유저 ID
			,	U.USERNAME 			-- 유저명 
			,	U.PHONENUMBER 		-- 연락처
			,	U.EMAILADDRESS 		-- 이메일
			,	E.SUBJECTID 		-- 종목 ID
			,	S.SUBJECTNAME 		-- 종목명(자격종별)
			,	R.RECEIPTDATE 		-- 접수일
			,	E.EXAMDATE 			-- 시험일
			,	R.PAYMENTMETHOD 	-- 결제정보
		FROM 	YS_RECEIPT			R 
		INNER JOIN YS_EXAM  		E 	ON	E.EXAMID = R.EXAMID 
		INNER JOIN YS_USER  		U 	ON 	U.USERID = R.USERID 
		INNER JOIN YS_SUBJECT  	 	S 	ON 	S.SUBJECTID = E.SUBJECTID 
		INNER JOIN YS_EXAMZONE		EZ	ON	EZ.EXAMZONEID = R.EXAMZONEID
		WHERE 	1 = 1
		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
		AND 	R.RECEIPTID = #{receiptId, jdbcType=VARCHAR};
   </select>
   
   <!-- 로그인 유저의 접수결과 조회 -->
   <select id="getDetailApplyInfo" parameterType="map" resultMap="DetailApplyListResultMap">
		SELECT 	
				E.EXAMID 			-- 시험 ID 
			,	E.EXAMNAME 			-- 시험명
			,	EZ.EXAMZONENAME 	-- 시험장명
			,	CONCAT(CONVERT(DATE_FORMAT(E.EXAMDATE, '%Y'), CHAR), '년', ' ', CONVERT(E.EXAMDEGREE, CHAR), '회')	AS EXAMDEGREE	-- 시험회차
			,	U.USERID 			-- 유저 ID
			,	U.USERNAME 			-- 유저명 
			,	U.PHONENUMBER 		-- 연락처
			,	U.EMAILADDRESS 		-- 이메일
			,	U.BIRTHDATE 		-- 생년월일
			,	E.SUBJECTID 		-- 종목 ID
			,	S.SUBJECTNAME 		-- 종목명(자격종별)
			,	DATE_FORMAT(R.RECEIPTDATE, '%Y-%m-%d') 	AS RECEIPTDATE
			,	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') 	AS EXAMDATE
			,	R.PAYMENTMETHOD 	-- 결제정보
			, 	R.RECEIPTID			-- 접수번호
			,	R.STUDENTCODE		-- 수험번호
			,	R.EXAMFEE			-- 응시료
			,	DATE_FORMAT(E.GRADESTARTDATE, '%Y-%m-%d') 	AS GRADESTARTDATE
			,	DATE_FORMAT(E.GRADEENDDATE, '%Y-%m-%d') 	AS GRADEENDDATE
			,	R.CERTID 			-- 교육수료증 번호
		FROM 	YS_RECEIPT			R 
		INNER JOIN YS_EXAM  		E 	ON	E.EXAMID = R.EXAMID 
		INNER JOIN YS_USER  		U 	ON 	U.USERID = R.USERID 
		INNER JOIN YS_SUBJECT  	 	S 	ON 	S.SUBJECTID = E.SUBJECTID 
		INNER JOIN YS_EXAMZONE		EZ 	ON 	EZ.EXAMZONEID = R.EXAMZONEID
		WHERE 	1 = 1
		AND 	R.USERID = #{userId}
		AND 	R.RECEIPTID = #{receiptId};
   </select>
   
   <!-- 응시결과 조회 -->
   <select id="getExamResult" parameterType="String" resultMap="DetailApplyListResultMap">
		SELECT 	
				E.EXAMID 			-- 시험 ID 
			,	E.EXAMNAME 			-- 시험명
			, 	R.RECEIPTID			-- 접수번호
			, 	G.ALLSCORE
			, 	(
				CASE
					WHEN G.ALLSCORE >= 60 THEN '합격'
					ELSE '불합격'
				END 
				)	AS ISPASS

		FROM 	YS_RECEIPT			R 
		INNER JOIN YS_EXAM  		E 	ON	E.EXAMID = R.EXAMID 
		INNER JOIN YS_GRADE 		G 	ON	G.RECEIPTID = R.RECEIPTID 
		WHERE 	1 = 1
		AND 	R.USERID = #{userId}
		AND     E.EXAMDATE >= DATE_ADD(NOW(), INTERVAL -36 MONTH);
   </select>
   
    <!-- 로그인 유저의 원서접수 현황 총 갯수 조회 -->
   <select id="countApplyReceptionStatusListTotal"  parameterType="String" resultType="Integer">
   		SELECT 	count(*)
 		FROM   	YS_RECEIPT	R
 		INNER JOIN YS_EXAM	E	ON	E.EXAMID = R.EXAMID
 		INNER JOIN YS_EXAMZONE EZ ON EZ.EXAMZONEID = R.EXAMZONEID
 		WHERE	1 = 1
 		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
 		AND 	R.ISCANCEL = 'N'
 		<![CDATA[
		AND 	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d')
		]]> 
	</select>
	
	<!-- 로그인 유저의 원서접수 리스트 조회(LIMIT 페이징) -->
	<select id="getApplyReceptionStatusList" parameterType="com.yeosin.apply.ApplyDto" resultMap="ApplyListResultMap">
		SELECT 	
				R.RECEIPTID 				-- 접수 ID
			,	R.USERID 					-- 유저 ID
			,	R.EXAMID					-- 시험 ID
			,   R.ISCANCEL					-- 취소여부
			,	E.EXAMNAME 					-- 시험명
			, 	E.EXAMDEGREE				-- 시험회차
         	,   DATE_FORMAT(E.RECEIPTENDDATE, '%Y-%m-%d %H:%i:%S')       AS RECEIPTENDDATE    	-- 접수마감일
			,	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d')				AS EXAMDATE				-- 시험일
			,	EZ.LOCALDETAIL 				-- 시험지역
		FROM 	YS_RECEIPT					R 	
		INNER JOIN YS_EXAM 					E	ON 	E.EXAMID = R.EXAMID 	
		INNER JOIN YS_EXAMZONE				EZ 	ON 	EZ.EXAMZONEID = R.EXAMZONEID
		WHERE 	1 = 1
		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
		AND 	R.ISCANCEL = 'N'
		<![CDATA[
		AND 	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d')
		]]> 
		ORDER BY E.EXAMDATE DESC
		LIMIT #{pageStart}, #{perPageNum};
   </select>
   
   <!-- 접수번호의 MAX값 조회 -->
   <select id="getMaxReceiptNumber" resultType="String">
	   	SELECT 
	   			<![CDATA[
				CASE WHEN CONVERT(CONCAT(CONVERT(DATE_FORMAT(NOW(), '%Y%m%d'), CHAR), '00000'), UNSIGNED)	
						  > MAX(CONVERT(RIGHT(RECEIPTID, 13), UNSIGNED))
					 THEN CONVERT(CONCAT(CONVERT(DATE_FORMAT(NOW(), '%Y%m%d'), CHAR), '00000'), CHAR)
					 ELSE CONVERT(MAX(CONVERT(RIGHT(RECEIPTID, 13), UNSIGNED)), CHAR) END	AS  MAXRECEIPTID
				]]>
		FROM 	YS_RECEIPT
		WHERE 	1 = 1;
	</select>
	
	<!-- 새로운 접수 Insert (결제 완료건에 대해) -->
	<insert id="setReceiptInfo" parameterType="com.yeosin.apply.ApplyDto">
		INSERT INTO YS_RECEIPT (RECEIPTID, USERID, EXAMID, CERTID, RECEIPTDATE, ISCANCEL
								, STUDENTCODE, SEATNUMBER, EXAMZONEID, PAYMENTMETHOD, CARDNAME, EXAMFEE)
		VALUES (#{receiptId}, #{userId}, #{examId}, #{certId}, NOW(), 'N'
				, #{studentCode}, '임시1', #{examZoneId}, #{paymentMethod}, #{cardName}, #{examFee});
	</insert>
	
   <!-- 해당시험에 이미 접수된 건이 있는지 확인 -->
   <select id="getIsReceipt"  parameterType="map" resultType="Integer">
		SELECT 	COUNT(*)
		FROM 	YS_RECEIPT
		WHERE 	1 = 1
		AND 	USERID = #{userId, jdbcType=VARCHAR}
		AND 	EXAMID = #{examId, jdbcType=VARCHAR}
		AND 	ISCANCEL = 'N'
	</select>
</mapper>
