<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yeosin.apply.ApplyDao" >
   
	<!-- 로그인 유저의 원서접수 리스트 조회 -->
	<resultMap id="ApplyListResultMap" type="com.yeosin.apply.ApplyDto">
		<result column="RECEIPTID" property="receiptId" />
		<result column="USERID" property="userId" />
		<result column="EXAMID" property="examId" />
		<result column="ISCANCEL" property="isCancel"/>
 		<association property="examDto" javaType="com.yeosin.apply.ExamDto">
			<result column="EXAMNAME" property="examName" />
			<result column="EXAMDEGREE" property="examDegree"/>
			<result column="RECEIPTSTARTDATE" property="receiptStartDate" />
			<result column="RECEIPTENDDATE" property="receiptEndDate" />
			<result column="EXAMDATE" property="examDate" />
			<result column="EXAMLOCAL" property="examLocal" />
		</association>
	</resultMap>
	<select id="GetApplyList" parameterType="com.yeosin.apply.ApplyDto" resultMap="ApplyListResultMap">
		SELECT 	
				R.RECEIPTID 				-- 접수 ID
			,	R.USERID 					-- 유저 ID
			,	R.EXAMID					-- 시험 ID
			,   R.ISCANCEL					-- 취소여부
			,	E.EXAMNAME 					-- 시험명
			,   DATE_FORMAT(E.RECEIPTSTARTDATE, '%Y-%m-%d')    	AS RECEIPTSTARTDATE 	-- 접수시작일
         	,   DATE_FORMAT(E.RECEIPTENDDATE, '%Y-%m-%d')       AS RECEIPTENDDATE    	-- 접수마감일
			,	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d')				AS EXAMDATE				-- 시험일
			,	E.EXAMLOCAL 				-- 시험지역
		FROM 	YS_RECEIPT					R 	
		INNER JOIN YS_EXAM 					E	ON 	E.EXAMID = R.EXAMID 	
		WHERE 	1 = 1
		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
		AND 	R.ISCANCEL = 'N'
		<![CDATA[
		AND 	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d')
		]]>
		ORDER BY E.EXAMDATE DESC
		LIMIT #{pageStart}, #{perPageNum};
   </select>
   
   <!-- 로그인 유저의 원서접수 총 갯수 조회 -->
   <select id="countApplyListTotal"  parameterType="String" resultType="Integer">
   		SELECT 	count(*)
 		FROM   	YS_RECEIPT	R
 		INNER JOIN YS_EXAM	E	ON	E.EXAMID = R.EXAMID
 		WHERE	1 = 1
 		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
 		AND 	R.ISCANCEL = 'N'
		<![CDATA[
		AND 	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d');
		]]> 
	</select>
   
   	<!-- 로그인 유저의 접수별 상세현황 조회 -->
	<resultMap id="DetailApplyListResultMap" type="com.yeosin.apply.ApplyDto">
		<result column="RECEIPTDATE" property="receiptDate" />
		<result column="PAYMENTMETHOD" property="paymentMethod" />
		<result column="RECEIPTID" property="receiptId" />
		<result column="STUDENTCODE" property="studentCode" />
		<result column="EXAMFEE" property="examFee" />
		<result column="CERTID" property="certId" />
 		<association property="examDto" javaType="com.yeosin.apply.ExamDto">
			<result column="EXAMID" property="examId" />
			<result column="EXAMNAME" property="examName" />
			<result column="EXAMDEGREE" property="examDegree" />
			<result column="SUBJECTID" property="subjectId" />
			<result column="EXAMDATE" property="examDate" />
			<result column="GRADESTARTDATE" property="gradeStartDate" />
			<result column="GRADEENDDATE" property="gradeEndDate" />
			<result column="EXAMLOCAL" property="examLocal" />
		</association>
		<association property="userDto" javaType="com.yeosin.user.UserDto">
			<result column="USERID" property="userId" />
			<result column="USERNAME" property="userName" />
			<result column="PHONENUMBER" property="phoneNumber" />
			<result column="EMAILADDRESS" property="emailAddress" />
			<result column="BIRTHDATE" property="birthDate" />
		 </association>
		 <association property="subjectDto" javaType="com.yeosin.apply.SubjectDto">
			<result column="SUBJECTNAME" property="subjectName" />
		</association>
		<association property="gradeDto" javaType="com.yeosin.apply.GradeDto">
			<result column="ALLSCORE" property="allScore" />
			<result column="ISPASS" property="isPass" />
		</association>
	</resultMap>
	<select id="GetDetailApplyList" parameterType="map" resultMap="DetailApplyListResultMap">
		SELECT 	
				E.EXAMID 			-- 시험 ID 
			,	E.EXAMNAME 			-- 시험명
			,	E.EXAMDEGREE 		-- 시험차수
			,	U.USERID 			-- 유저 ID
			,	U.USERNAME 			-- 유저명 
			,	U.PHONENUMBER 		-- 연락처
			,	U.EMAILADDRESS 		-- 이메일
			,	E.SUBJECTID 		-- 종목 ID
			,	S.SUBJECTNAME 		-- 종목명(자격종별)
			,	R.RECEIPTDATE 		-- 접수일
			,	E.EXAMDATE 			-- 시험일
			,	R.PAYMENTMETHOD 	-- 결제정보
		FROM 	YS_RECEIPT			R 
		INNER JOIN YS_EXAM  		E 	ON	E.EXAMID = R.EXAMID 
		INNER JOIN YS_USER  		U 	ON 	U.USERID = R.USERID 
		INNER JOIN YS_SUBJECT  	 	S 	ON 	S.SUBJECTID = E.SUBJECTID 
		WHERE 	1 = 1
		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
		AND 	R.RECEIPTID = #{receiptId, jdbcType=VARCHAR};
   </select>
   
   <select id="getDetailApplyInfo" parameterType="map" resultMap="DetailApplyListResultMap">
		SELECT 	
				E.EXAMID 			-- 시험 ID 
			,	E.EXAMNAME 			-- 시험명
			,	E.EXAMLOCAL 		-- 시험장명
			,	E.EXAMDEGREE 		-- 시험차수
			,	U.USERID 			-- 유저 ID
			,	U.USERNAME 			-- 유저명 
			,	U.PHONENUMBER 		-- 연락처
			,	U.EMAILADDRESS 		-- 이메일
			,	U.BIRTHDATE 		-- 생년월일
			,	E.SUBJECTID 		-- 종목 ID
			,	S.SUBJECTNAME 		-- 종목명(자격종별)
			,	DATE_FORMAT(R.RECEIPTDATE, '%Y-%m-%d') 	AS RECEIPTDATE
			,	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d') 	AS EXAMDATE
			,	R.PAYMENTMETHOD 	-- 결제정보
			, 	R.RECEIPTID			-- 접수번호
			,	R.STUDENTCODE		-- 수험번호
			,	R.EXAMFEE			-- 응시료
			,	DATE_FORMAT(E.GRADESTARTDATE, '%Y-%m-%d') 	AS GRADESTARTDATE
			,	DATE_FORMAT(E.GRADEENDDATE, '%Y-%m-%d') 	AS GRADEENDDATE
			,	R.CERTID 			-- 교육수료증 번호
		FROM 	YS_RECEIPT			R 
		INNER JOIN YS_EXAM  		E 	ON	E.EXAMID = R.EXAMID 
		INNER JOIN YS_USER  		U 	ON 	U.USERID = R.USERID 
		INNER JOIN YS_SUBJECT  	 	S 	ON 	S.SUBJECTID = E.SUBJECTID 
		WHERE 	1 = 1
		AND 	R.USERID = #{userId}
		AND 	R.RECEIPTID = #{receiptId};
   </select>
   
   <select id="getExamResult" parameterType="String" resultMap="DetailApplyListResultMap">
		SELECT 	
				E.EXAMID 			-- 시험 ID 
			,	E.EXAMNAME 			-- 시험명
			, 	R.RECEIPTID			-- 접수번호
			, 	G.ALLSCORE
			, 	(
				CASE
					WHEN G.ALLSCORE >= 60 THEN '합격'
					ELSE '불합격'
				END 
				)	AS ISPASS

		FROM 	YS_RECEIPT			R 
		INNER JOIN YS_EXAM  		E 	ON	E.EXAMID = R.EXAMID 
		INNER JOIN YS_GRADE 		G 	ON	G.RECEIPTID = R.RECEIPTID 
		WHERE 	1 = 1
		AND 	R.USERID = #{userId}
   </select>
   
    <!-- 로그인 유저의 원서접수 현황 총 갯수 조회 -->
   <select id="countApplyReceptionStatusListTotal"  parameterType="String" resultType="Integer">
   		SELECT 	count(*)
 		FROM   	YS_RECEIPT	R
 		INNER JOIN YS_EXAM	E	ON	E.EXAMID = R.EXAMID
 		WHERE	1 = 1
 		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
 		AND 	R.ISCANCEL = 'N'
	</select>
	
	<select id="getApplyReceptionStatusList" parameterType="com.yeosin.apply.ApplyDto" resultMap="ApplyListResultMap">
		SELECT 	
				R.RECEIPTID 				-- 접수 ID
			,	R.USERID 					-- 유저 ID
			,	R.EXAMID					-- 시험 ID
			,   R.ISCANCEL					-- 취소여부
			,	E.EXAMNAME 					-- 시험명
			, 	E.EXAMDEGREE				-- 시험회차
			,   DATE_FORMAT(E.RECEIPTSTARTDATE, '%Y-%m-%d')    	AS RECEIPTSTARTDATE 	-- 접수시작일
         	,   DATE_FORMAT(E.RECEIPTENDDATE, '%Y-%m-%d')       AS RECEIPTENDDATE    	-- 접수마감일
			,	DATE_FORMAT(E.EXAMDATE, '%Y-%m-%d')				AS EXAMDATE				-- 시험일
			,	E.EXAMLOCAL 				-- 시험지역
		FROM 	YS_RECEIPT					R 	
		INNER JOIN YS_EXAM 					E	ON 	E.EXAMID = R.EXAMID 	
		WHERE 	1 = 1
		AND 	R.USERID = #{userId, jdbcType=VARCHAR}
		AND 	R.ISCANCEL = 'N'
		ORDER BY E.EXAMDATE DESC
		LIMIT #{pageStart}, #{perPageNum};
   </select>
   
</mapper>
